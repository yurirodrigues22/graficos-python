<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Gráficos</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Estilo custom -->
    <link href="../static/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

</head>

<body class="viewport">

    <nav>
        <div>
            <h2>Dashboard Analytics</h2>
        </div>
    </nav>

    <div>
        <div class="content">
            <div class="box card-um">
                <h1 class="sub-titulo">Análise de Dados</h1>

                <form id="form-dash" class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Escolha a Análise</label>
                        <p>
                            <select id="analise" class="form-select form-select-lg">
                                <option value="sexo">Distribuição por Sexo</option>
                                <option value="idade">Perfil Etário da População</option>
                                <option value="titular">Distribuição por Tipo</option>
                                <option value="situacao">Situação dos Dependentes</option>
                                <option value="alerta">Dependentes com Alerta</option>
                                <option value="dependentes_parentesco">Dependentes por Grau de Parentesco</option>
                                <option value="sexo_titulares">Distribuição por sexo dentro dos titulares</option>
                                <option value="carteira">Carteira Segurados</option>
                                
                             
                            </select>
                        </p>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Gráfico</label>
                        <p>
                            <select id="tipo" class="form-select form-select-lg">
                                <option value="bar">Barras</option>
                                <option value="pie">Pizza</option>
                                <option value="line">Linha</option>
                            </select>
                        </p>
                    </div>

                    <div class="col-12 text-center">
                        <button class="btn btn-primary btn-lg px-5" type="submit">Gerar Gráfico</button>
                    </div>
                </form>
            </div>

            <div class="box card-dois">
                <div class="card shadow-lg border-0 rounded-4 p-4 mt-5">
                    <h2 class="h4 fw-bold text-secondary mb-3">Resultado</h2>
                    <canvas id="grafico"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 bg-light border-top mt-5">
        <p class="mb-0 text-muted">Desenvolvido para análise de dados — 2025</p>
    </footer>

    <script>
        const ctx = document.getElementById('grafico').getContext('2d');
        let chart = null;

        function cores(n) {
            const base = [
                '#4e79a7', '#e15759',
                '#59a14f', '#edc948', '#b07aa1', '#ff9da7',
                '#9c755f', '#bab0ab'
            ];
            return Array.from({ length: n }, (_, i) => base[i % base.length]);
        }

        async function desenhar() {
            const analise = document.getElementById('analise').value;
            const tipo = document.getElementById('tipo').value;

            const res = await fetch(`/api/dados?analise=${analise}`);
            const data = await res.json();

            // fallback se não vier nada
            const labels = data.labels && data.labels.length ? data.labels : ["Sem dados"];
            const valores = data.valores && data.valores.length ? data.valores : [0];

            const cfg = {
                type: tipo,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: valores,
                        backgroundColor: tipo === 'pie' ? cores(labels.length) : cores(1),
                        borderColor: '#1f2d3d',
                        borderWidth: tipo === 'pie' ? 0 : 1,
                        tension: 0.3,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: tipo === 'pie' },
                        title: {
                            display: true,
                            text:
                                analise === 'sexo' ? 'Distribuição por Sexo' :
                                    analise === 'idade' ? 'Distribuição por Faixa Etária' :
                                        analise === 'situacao' ? 'Situação dos Dependentes' :
                                            analise === 'carteira' ? 'Carteira Unimed' :
                                                analise === 'titular' ? 'Distribuição por Tipo (Titular x Dependente)' :
                                                    'Análise'
                        },
                        tooltip: { enabled: true }
                    },
                    scales: (tipo === 'pie') ? {} : {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            };

            if (chart) chart.destroy();
            chart = new Chart(ctx, cfg);
        }

        document.getElementById('form-dash').addEventListener('submit', (e) => {
            e.preventDefault();
            desenhar();
        });

        window.addEventListener('DOMContentLoaded', desenhar);
    </script>
</body>

</html>
