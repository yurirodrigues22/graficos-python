<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Gráficos</title>

    <!-- Bootstrap -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Estilo custom -->
    <link href="../static/style.css" rel="stylesheet" />
</head>

<body class="viewport">

    <nav class="">
        <div class="">
            <h2 class="" href="/">Dashboard Analytics</h2>
        </div>
    </nav>

    <div class="">
        
        <div class="content">
            <div class="box card-um">
                <h1 class="sub-titulo">Análise de Dados</h1>

                <form id="form-dash" class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Escolha a Análise</label>
                        <p>
                            <select id="analise" class="form-select form-select-lg">
                                <option value="sexo">Distribuição por Sexo</option>
                                <option value="idade">Perfil Etário da População
                            </select>
                        </p>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Gráfico</label>
                        <p>
                            <select id="tipo" class="form-select form-select-lg">
                                <option value="bar">Barras</option>
                                <option value="pie">Pizza</option>
                                <option value="line">Linha</option>
                            </select>
                        </p>
                    </div>

                    <div class="col-12 text-center">
                        <button class="btn btn-primary btn-lg px-5" type="submit">Gerar Gráfico</button>
                    </div>
                </form>
            </div>


            <div class="box card-dois">
                <div class="card shadow-lg border-0 rounded-4 p-4 mt-5">
                    <h2 class="h4 fw-bold text-secondary mb-3">Resultado</h2>
                    <div class="ratio ratio-16x9">
                        <canvas id="grafico"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <footer class="text-center py-4 bg-light border-top mt-5">
        <p class="mb-0 text-muted">Desenvolvido para análise de dados — 2025</p>
    </footer>

    <script>
        const ctx = document.getElementById('grafico');
        let chart = null;

        function cores(n) {
            // Paleta simples e distinta (repete se necessário)
            const base = [
                '#4e79a7', '#76b7b2', '#e15759', 
                '#59a14f', '#edc948', '#b07aa1', '#ff9da7',
                '#9c755f', '#bab0ab'
            ];
            const arr = [];
            for (let i = 0; i < n; i++) arr.push(base[i % base.length]);
            return arr;
        }

        async function desenhar() {
            const analise = document.getElementById('analise').value;
            const tipo = document.getElementById('tipo').value;

            const res = await fetch(`/api/dados?analise=${analise}`);
            const data = await res.json();

            const cfg = {
                type: tipo,
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: data.valores,
                        backgroundColor: tipo === 'pie' ? cores(data.labels.length) : cores(1),
                        borderColor: '#1f2d3d',
                        borderWidth: tipo === 'pie' ? 0 : 1,
                        tension: 0.3,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: tipo === 'pie' },
                        title: {
                            display: true,
                            text: analise === 'sexo' ? 'Distribuição por Sexo' : 'Distribuição por Idade'
                        },
                        tooltip: { enabled: true }
                    },
                    scales: (tipo === 'pie') ? {} : {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            };

            if (chart) chart.destroy();
            chart = new Chart(ctx, cfg);
        }

        document.getElementById('form-dash').addEventListener('submit', (e) => {
            e.preventDefault();
            desenhar();
        });

        // Desenha ao carregar
        window.addEventListener('DOMContentLoaded', desenhar);
    </script>
</body>

</html>